#!/bin/sh

LIB=0;

for arg in "$@"; do
    case "$arg" in
        lib)
            LIB=1;
            ;;
    esac
done

CC="${CC:-clang}"
CFLAGS="${CFLAGS:--O3 -fno-stack-clash-protection}"
INCLUDE="-Iinclude";
CSTRICT="-nostdlib \
        -std=c89 \
        -pedantic \
        -Werror \
        -Wall \
        -Wextra \
        -Wshadow \
        -Wpointer-arith \
        -Wcast-qual \
        -Wmissing-prototypes \
        -Wmissing-declarations"
BIN_DIR=target/bin
LIB_DIR=target/lib

if [ "${LIB}" = "1" ]; then
    mkdir -p ${LIB_DIR};
else
    mkdir -p ${BIN_DIR};
fi

ARCH=$(uname -m 2>/dev/null || echo unknown)

case "$ARCH" in
    x86_64|amd64)
        ARCH_FLAGS="-march=haswell -mavx2"
        ;;
    aarch64|arm64|armv8*)
        ARCH_FLAGS="-march=armv8-a+crypto"
        ;;
    *)
        ARCH_FLAGS="-march=native"
        ;;
esac


if [ "${LIB}" = "0" ]; then
    COMMAND="${CC} \
	${INCLUDE} \
	${ARCH_FLAGS} \
	${CFLAGS} \
	${CSTRICT} \
	-o ${BIN_DIR}/test \
	main.c";
else
    COMMAND="${CC} \
	${INCLUDE} \
	${ARCH_FLAGS} \
	${CFLAGS} \
	${CSTRICT} \
	-shared \
	-fPIC \
	-DCOMPRESS_IMPL \
	-x c  \
	include/compress.h
	-o ${LIB_DIR}/libcompress.so"
fi

echo ${COMMAND};
${COMMAND};
