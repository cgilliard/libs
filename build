#!/bin/sh

ALL=0;
TEST=0;
CLEAN=0;
INSTALL=0;
CC="${CC:-clang}"
CFLAGS="${CFLAGS:--O3 -fno-stack-clash-protection}"
INCLUDE_DIR=include
INCLUDE="-I${INCLUDE_DIR}";
CSTRICT="-nostdlib \
	-fvisibility=hidden \
        -std=c99 \
        -Werror \
        -Wextra \
        -Wshadow \
        -Wpointer-arith \
        -Wcast-qual \
        -Wmissing-prototypes \
        -Wmissing-declarations"
BIN_DIR=target/bin
LIB_DIR=target/lib

for arg in "$@"; do
    case "$arg" in
        all)
            ALL=1;
            ;;
	test)
	    TEST=1;
	    ;;
	clean)
	    CLEAN=1;
	    ;;
	install)
	    INSTALL=1;
	    ;;
    esac
done

if [ "${CLEAN}" = "0" ] && [ "${TEST}" = "0" ] && [ "${INSTALL}" = "0" ]; then
	ALL=1;
fi

if [ "${ALL}" = "1" ]; then
    mkdir -p ${LIB_DIR};
elif [ "${TEST}" = "1" ]; then
    mkdir -p ${BIN_DIR};
fi

ARCH=$(uname -m 2>/dev/null || echo unknown)

case "$ARCH" in
    x86_64|amd64)
        ARCH_FLAGS="-march=haswell -mavx2"
        ;;
    aarch64|arm64|armv8*)
        ARCH_FLAGS="-march=armv8-a+crypto"
        ;;
    *)
        ARCH_FLAGS="-march=native"
        ;;
esac

if [ "${CLEAN}" = "1" ]; then
	rm -rf ${BIN_DIR} ${LIB_DIR}
fi


if [ "${TEST}" = "1" ]; then
    COMMAND="${CC} \
	${INCLUDE} \
	${ARCH_FLAGS} \
	${CFLAGS} \
	${CSTRICT} \
	-o ${BIN_DIR}/test \
	test/main.c";
    echo ${COMMAND};
    ${COMMAND} || exit 1;
    ${BIN_DIR}/test || exit 1;
elif [ "${ALL}" = "1" ]; then
    for src in "$INCLUDE_DIR"/libfam/*.h; do
	base=$(basename "$src" .h)
        impl=$(echo "$base" | tr 'a-z' 'A-Z')_IMPL
        COMMAND="${CC} \
	    ${INCLUDE} \
            ${ARCH_FLAGS} \
            ${CFLAGS} \
            ${CSTRICT} \
            -shared \
            -fPIC \
            -D${impl} \
            -x c  \
            ${src} \
            -o ${LIB_DIR}/lib${base}.so"
        echo ${COMMAND};
        ${COMMAND} || exit 1;
    done
elif [ "${INSTALL}" = "1" ]; then
	mkdir -p /usr/lib/libfam/
	cp -rp ${LIB_DIR}/*.so /usr/lib/libfam
fi

